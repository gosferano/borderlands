---
import Layout from '../layouts/BaseLayout.astro';
---

<Layout title="Borderlands 4 Save Tool - Decrypt & Encrypt">
  <section class="mx-auto max-w-5xl px-6 py-10">
    <h1 class="mb-6 text-center text-4xl font-bold">Borderlands 4 save editor</h1>
    <div class="bl4-save-tool bg-bl-dark rounded-lg p-6 shadow-xl">
      <h2 class="text-bl-yellow mb-6 text-2xl font-bold">Decrypt Save Data (.sav)</h2>

      <div class="space-y-6">
        <!-- User ID Input Section -->
        <section>
          <label for="userIdInput" class="block font-semibold"> Platform User ID </label>
          <input
            type="text"
            id="userIdInput"
            placeholder="Enter Steam ID or Epic ID"
            class="w-full rounded-md border px-3 py-2 focus:outline-none"
          />
        </section>

        <!-- Decrypt Section -->
        <section>
          <div class="mb-4">
            <label for="userIdInput" class="block font-semibold">Upload .sav File</label>
            <input
              type="file"
              id="decryptFileInput"
              accept=".sav"
              class="w-full rounded-md border px-3 py-2 file:-mx-3 file:-my-2 file:me-3 file:cursor-pointer file:overflow-hidden file:rounded-none file:border-r file:border-inherit file:px-3 file:py-2 focus:outline-none"
            />
          </div>

          <button
            id="decryptBtn"
            class="text-bl-dark hover:bg-bl-orange rounded-md bg-orange-700 px-6 py-2 font-semibold hover:bg-orange-600 disabled:opacity-50"
            disabled
          >
            Decrypt Save File
          </button>
        </section>

        <!-- Edit Section -->
        <section id="editSection" class="hidden">
          <h3 class="text-bl-yellow mb-4 text-xl font-bold">Edit Save Data (YAML)</h3>

          <div class="mb-4">
            <textarea
              id="yamlEditor"
              rows="20"
              class="w-full rounded-md border px-3 py-2 font-mono focus:outline-none"
              placeholder="Decrypted YAML will appear here..."></textarea>
          </div>

          <div class="flex flex-wrap gap-4">
            <button
              id="encryptBtn"
              class="text-bl-dark hover:bg-bl-orange rounded-md bg-orange-700 px-6 py-2 font-semibold hover:bg-orange-600 disabled:opacity-50"
            >
              Encrypt & Download .sav
            </button>

            <button
              id="downloadYamlBtn"
              class="rounded-md bg-green-700 px-4 py-2 text-white hover:bg-green-600"
            >
              Download YAML
            </button>

            <button
              id="copyYamlBtn"
              class="rounded-md bg-gray-700 px-4 py-2 text-gray-100 hover:bg-gray-600"
            >
              Copy YAML
            </button>
          </div>
        </section>

        <!-- Messages -->
        <div
          id="errorMessage"
          class="hidden rounded-md border border-red-500 bg-red-900/50 px-4 py-3 text-red-200"
        >
        </div>

        <div
          id="successMessage"
          class="hidden rounded-md border border-green-500 bg-green-900/50 px-4 py-3 text-green-200"
        >
        </div>

        <!-- Instructions -->
        <div class="mt-6 rounded-lg border border-blue-500 bg-blue-900/30 p-4">
          <h4 class="mb-2 font-bold text-blue-200">üí° How to Use:</h4>
          <ol class="list-decimal space-y-1 text-sm text-blue-200">
            <li>Enter your Steam ID or Epic ID (required for encryption/decryption)</li>
            <li>Select a .sav file to decrypt</li>
            <li>Click "Decrypt Save File" to view and edit the YAML content</li>
            <li>Make your changes in the editor</li>
            <li>Click "Encrypt & Download .sav" to save your modified file</li>
          </ol>
        </div>

        <!-- Warning -->
        <div class="rounded-lg border border-yellow-500 bg-yellow-900/30 p-4">
          <h4 class="mb-2 font-bold text-yellow-300">‚ö†Ô∏è Important:</h4>
          <ul class="list-disc space-y-1 text-sm text-yellow-200">
            <li>Always backup your original save files before editing</li>
            <li>Wrong User ID will result in corrupted saves</li>
            <li>YAML syntax errors will prevent re-encryption</li>
            <li>Keep your User ID private and secure</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</Layout>

<!-- Load required libraries from CDN -->
<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"
></script>
<script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

<script>
  import { decryptSave, encryptSave, downloadFile } from '../utils/saveDecryptor';

  let currentYaml = '';
  let originalFilename = '';

  // DOM elements
  const userIdInput = document.getElementById('userIdInput') as HTMLInputElement;
  const decryptFileInput = document.getElementById('decryptFileInput') as HTMLInputElement;
  const decryptBtn = document.getElementById('decryptBtn') as HTMLButtonElement;
  const editSection = document.getElementById('editSection') as HTMLElement;
  const yamlEditor = document.getElementById('yamlEditor') as HTMLTextAreaElement;
  const encryptBtn = document.getElementById('encryptBtn') as HTMLButtonElement;
  const copyYamlBtn = document.getElementById('copyYamlBtn') as HTMLButtonElement;
  const downloadYamlBtn = document.getElementById('downloadYamlBtn') as HTMLButtonElement;
  const errorMessage = document.getElementById('errorMessage') as HTMLDivElement;
  const successMessage = document.getElementById('successMessage') as HTMLDivElement;

  // Load previous user ID if exists
  const savedUserId = localStorage.getItem('bl4_previous_userid');
  if (savedUserId && userIdInput) {
    userIdInput.value = savedUserId;
  }

  // Enable decrypt button when file is selected
  decryptFileInput?.addEventListener('change', () => {
    if (decryptFileInput.files && decryptFileInput.files.length > 0) {
      decryptBtn.disabled = false;
      originalFilename = decryptFileInput.files[0].name.replace('.sav', '');
    } else {
      decryptBtn.disabled = true;
    }
  });

  // Decrypt button handler
  decryptBtn?.addEventListener('click', async () => {
    hideMessages();

    const file = decryptFileInput?.files?.[0];
    const userId = userIdInput?.value.trim();

    if (!file) {
      showError('Please select a save file');
      return;
    }

    if (!userId) {
      showError('Please enter your Steam ID or Epic ID');
      return;
    }

    try {
      decryptBtn.disabled = true;
      decryptBtn.textContent = 'Decrypting...';

      const arrayBuffer = await file.arrayBuffer();
      currentYaml = await decryptSave(arrayBuffer, userId);

      // Save user ID for future use
      localStorage.setItem('bl4_previous_userid', userId);

      // Display YAML in editor
      yamlEditor.value = currentYaml;
      editSection.classList.remove('hidden');
      editSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      showSuccess('Save file decrypted successfully! Edit the YAML below.');
    } catch (error) {
      showError(`Failed to decrypt: ${(error as Error).message}`);
    } finally {
      decryptBtn.disabled = false;
      decryptBtn.textContent = 'Decrypt Save File';
    }
  });

  // Copy YAML button
  copyYamlBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(yamlEditor.value);
      showSuccess('YAML copied to clipboard!');
    } catch (error) {
      showError('Failed to copy to clipboard');
    }
  });

  // Download YAML button
  downloadYamlBtn?.addEventListener('click', () => {
    const blob = new Blob([yamlEditor.value], { type: 'text/yaml' });
    downloadFile(blob, `${originalFilename || 'save'}.yaml`);
    showSuccess('YAML file downloaded!');
  });

  // Encrypt button handler
  encryptBtn?.addEventListener('click', async () => {
    hideMessages();

    const userId = userIdInput?.value.trim();
    const editedYaml = yamlEditor?.value;

    if (!userId) {
      showError('Please enter your Steam ID or Epic ID');
      return;
    }

    if (!editedYaml) {
      showError('YAML content is empty');
      return;
    }

    try {
      encryptBtn.disabled = true;
      encryptBtn.textContent = 'Encrypting...';

      const blob = await encryptSave(editedYaml, userId);

      // Generate filename with timestamp
      const now = new Date();
      const timestamp = now.toISOString().replace(/[-:T]/g, '').slice(0, 14);
      const filename = `${originalFilename || 'save'}_${timestamp.slice(0, 8)}_${timestamp.slice(8)}.sav`;

      downloadFile(blob, filename);

      showSuccess('Encrypted save file downloaded successfully!');

      // Update current YAML
      currentYaml = editedYaml;
    } catch (error) {
      showError(`Failed to encrypt: ${(error as Error).message}`);
    } finally {
      encryptBtn.disabled = false;
      encryptBtn.textContent = 'Encrypt & Download .sav';
    }
  });

  function showError(message: string) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
    errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    setTimeout(() => errorMessage.classList.add('hidden'), 5000);
  }

  function showSuccess(message: string) {
    successMessage.textContent = message;
    successMessage.classList.remove('hidden');
    setTimeout(() => successMessage.classList.add('hidden'), 3000);
  }

  function hideMessages() {
    errorMessage.classList.add('hidden');
    successMessage.classList.add('hidden');
  }
</script>
