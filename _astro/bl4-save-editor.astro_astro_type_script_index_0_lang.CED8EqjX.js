const $=new Uint8Array([53,236,51,119,243,93,176,234,190,107,131,17,84,3,235,251,39,37,100,46,213,73,6,41,5,120,189,96,186,74,167,135]);function T(e){const o=[];for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);o.push(n&255,n>>8&255)}return o}function _(e){const o=new Uint8Array($);let t;if(/^\d{17,}$/.test(e)){let n=BigInt(e);t=[];for(let a=0;a<8;a++)t.push(Number(n&0xffn)),n>>=8n}else t=T(e);for(let n=0;n<Math.min(o.length,t.length);n++)o[n]^=t[n];return o}function W(e){const o=e[e.length-1];for(let n=1;n<=o;n++)if(e[e.length-n]!==o)return console.warn("PKCS7 unpad failed, returning padded data"),new Uint8Array(e);const t=new Uint8Array(e.length-o);return t.set(e.subarray(0,e.length-o)),t}function R(e,o=16){const t=o-e.length%o,n=new Uint8Array(e.length+t);return n.set(e),n.fill(t,e.length),n}function I(e){const o=[],t=e.length;for(let n=0;n<t;n+=4)o.push(e[n]<<24|e[n+1]<<16|e[n+2]<<8|e[n+3]);return window.CryptoJS.lib.WordArray.create(o,t)}async function J(e,o){if(!o)throw new Error("Please enter platform user ID (Steam or Epic)");const t=window.CryptoJS,n=window.pako;if(!t||!n)throw new Error("Required libraries not loaded");const a=new Uint8Array(e),d=_(o),L=I(d),p=I(a),l=t.AES.decrypt({ciphertext:p},L,{mode:t.mode.ECB,padding:t.pad.NoPadding});let r=new Uint8Array(l.words.length*4);for(let s=0;s<l.words.length;s++)r.set([l.words[s]>>24&255,l.words[s]>>16&255,l.words[s]>>8&255,l.words[s]&255],s*4);const f=new Uint8Array(a.length);f.set(r.subarray(0,a.length)),r=f,r=W(r);let k=[4,8],m=null,E=null;for(let s of k)try{const u=r.length-s,c=new Uint8Array(u);if(c.set(r.subarray(0,u)),c[0]!==120)continue;m=n.inflate(c),E=s;break}catch{}if(!m)throw new Error("Zlib decompress failed. Wrong user ID or file format?");return console.log(`Successfully decompressed with trim=${E}`),new TextDecoder().decode(m)}async function O(e,o){if(!o)throw new Error("Please enter platform user ID (Steam or Epic)");const t=window.CryptoJS,n=window.pako;if(!t||!n)throw new Error("Required libraries not loaded");const a=new TextEncoder().encode(e),d=n.deflate(a,{level:9});function L(c){let v=1,x=0;for(let U=0;U<c.length;U++)v=(v+c[U])%65521,x=(x+v)%65521;return(x<<16|v)>>>0}const p=L(a),l=a.length,r=new Uint8Array(d.length+8);r.set(d,0),r[d.length+0]=p&255,r[d.length+1]=p>>8&255,r[d.length+2]=p>>16&255,r[d.length+3]=p>>24&255,r[d.length+4]=l&255,r[d.length+5]=l>>8&255,r[d.length+6]=l>>16&255,r[d.length+7]=l>>24&255;const f=R(r),k=_(o),m=I(k),E=I(f),s=t.AES.encrypt(E,m,{mode:t.mode.ECB,padding:t.pad.NoPadding}),u=new Uint8Array(s.ciphertext.words.length*4);for(let c=0;c<s.ciphertext.words.length;c++)u.set([s.ciphertext.words[c]>>24&255,s.ciphertext.words[c]>>16&255,s.ciphertext.words[c]>>8&255,s.ciphertext.words[c]&255],c*4);return new Blob([u],{type:"application/octet-stream"})}function D(e,o){const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=o,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t)}let C="",Y="";const b=document.getElementById("userIdInput"),w=document.getElementById("decryptFileInput"),i=document.getElementById("decryptBtn"),M=document.getElementById("editSection"),A=document.getElementById("yamlEditor"),h=document.getElementById("encryptBtn"),K=document.getElementById("copyYamlBtn"),N=document.getElementById("downloadYamlBtn"),g=document.getElementById("errorMessage"),B=document.getElementById("successMessage"),P=localStorage.getItem("bl4_previous_userid");P&&b&&(b.value=P);w?.addEventListener("change",()=>{w.files&&w.files.length>0?(i.disabled=!1,Y=w.files[0].name.replace(".sav","")):i.disabled=!0});i?.addEventListener("click",async()=>{F();const e=w?.files?.[0],o=b?.value.trim();if(!e){y("Please select a save file");return}if(!o){y("Please enter your Steam ID or Epic ID");return}try{i.disabled=!0,i.textContent="Decrypting...";const t=await e.arrayBuffer();C=await J(t,o),localStorage.setItem("bl4_previous_userid",o),A.value=C,M.classList.remove("hidden"),M.scrollIntoView({behavior:"smooth",block:"nearest"}),S("Save file decrypted successfully! Edit the YAML below.")}catch(t){y(`Failed to decrypt: ${t.message}`)}finally{i.disabled=!1,i.textContent="Decrypt Save File"}});K?.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(A.value),S("YAML copied to clipboard!")}catch{y("Failed to copy to clipboard")}});N?.addEventListener("click",()=>{const e=new Blob([A.value],{type:"text/yaml"});D(e,`${Y||"save"}.yaml`),S("YAML file downloaded!")});h?.addEventListener("click",async()=>{F();const e=b?.value.trim(),o=A?.value;if(!e){y("Please enter your Steam ID or Epic ID");return}if(!o){y("YAML content is empty");return}try{h.disabled=!0,h.textContent="Encrypting...";const t=await O(o,e),a=new Date().toISOString().replace(/[-:T]/g,"").slice(0,14),d=`${Y||"save"}_${a.slice(0,8)}_${a.slice(8)}.sav`;D(t,d),S("Encrypted save file downloaded successfully!"),C=o}catch(t){y(`Failed to encrypt: ${t.message}`)}finally{h.disabled=!1,h.textContent="Encrypt & Download .sav"}});function y(e){g.textContent=e,g.classList.remove("hidden"),g.scrollIntoView({behavior:"smooth",block:"nearest"}),setTimeout(()=>g.classList.add("hidden"),5e3)}function S(e){B.textContent=e,B.classList.remove("hidden"),setTimeout(()=>B.classList.add("hidden"),3e3)}function F(){g.classList.add("hidden"),B.classList.add("hidden")}
